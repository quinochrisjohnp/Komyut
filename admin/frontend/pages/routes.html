<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Route Management</title>
  <link rel="stylesheet" href="./../css/style.css" />
  <!-- âœ… Added Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>

  <!-- âœ… Sidebar -->
<aside class="sidebar">
      <div class="profile">
        
        <h2>Super Admin</h2>
      </div>
    <ul class="menu" id="menu">
        <li data-page="dashboard" class="active">
            <a href="dashboard.html">Dashboard</a>
        </li>
        <li data-page="users">
            <a href="users.html">User Management</a>
        </li>
        <li data-page="routes">
            <a href="routes.html">Route Management</a>
        </li>
        <li data-page="notifications">
            <a href="notifications.html">Notifications Manager</a>
        </li>
        <li data-page="feedback">
            <a href="feedback.html">Feedbacks & Reports</a>
        </li>
        <li data-page="admin">
            <a href="admin.html">Admin Management</a>
        </li>
        <li data-page="logs">
            <a href="logs.html">Activity Logs</a>
        </li>
        <li data-page="logout">
            <a href="/admin/frontend/login.html">Logout</a>
        </li>
    </ul>
    </aside>

  <!-- âœ… Add Route Modal -->
  <div id="addRouteModal" class="modal">
    <div class="modal-content">
      <span id="closeModal" class="close">&times;</span>
      <h2>New Route</h2>

      <div class="modal-row">
        <input type="text" placeholder="Start location" class="input" />
        <span class="arrow">â†”</span>
        <input type="text" placeholder="Destination" class="input" />
      </div>

      <div class="modal-row">
        <select class="input">
          <option disabled selected>Vehicle Type</option>
          <option>Jeepney</option>
          <option>Tricycle</option>
          <option>UV Express</option>
          <option>Bus</option>
        </select>
        <input type="number" placeholder="Price" class="input" />
        <input type="text" placeholder="Description" class="input" />
      </div>

      <button class="submit-btn">Add Route</button>
    </div>
  </div>

  <!-- âœ… Main Content -->
  <div class="content-body">
    <header class="header">
      <h1>Route Management</h1>
    </header>

    <div class="content-body">

      <div class="row1">
        <div class="column1"><h2>Fare</h2></div>
        <div class="column1">
          <div class="search-route">
            <input class="search-input-route" type="search" placeholder="Search">
            <button type="button" class="search-submit-route">
              <span class="material-icons">search</span>
            </button>
          </div>
        </div>
      </div>

      <!-- âœ… Category Buttons -->
      <!-- âœ… Category Buttons -->
      <div class="row2">
        <div class="column2"><button class="buttonz active" data-table="jeep">Jeepney Pricing</button></div>
        <div class="column2"><button class="buttonz" data-table="tric">Tricycle Pricing</button></div>
        <div class="column2"><button class="buttonz" data-table="uv">UV Express Pricing</button></div>
        <div class="column2"><button class="buttonz" data-table="bus">Bus Pricing</button></div>
      </div>

      <br>

      <!-- âœ… Single Unified Table -->
      <section class="table-container active" id="routesTable">
        <h3 id="tableTitle">Jeepney Pricing</h3>
        <table class="scrollable-table">
          <thead>
            <tr>
              <th>From</th>
              <th>To</th>
              <th>Estimated Price</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <button id="openAddRouteModal" class="add-route-btn">âž• Add Route</button>
    </div>
  </div>

  <script src="./../js/sidebar.js"></script>
  <!-- âœ… Script -->
  <script>
    const API_URL = "http://localhost:5002/api/add-route";

    let allRoutes = [];
    let currentCategory = "jeep";

    async function fetchRoutes() {
      try {
        const res = await fetch(API_URL);
        if (!res.ok) throw new Error("Failed to fetch routes");
        const data = await res.json();
        allRoutes = data;
        renderCurrentCategory();
      } catch (err) {
        console.error("Error fetching routes:", err);
        alert("Could not fetch routes.");
      }
    }

    function filterRoutesByCategory(category) {
      return allRoutes.filter((r) => {
        const vt = (r.vehicle_type || "").toLowerCase();
        if (category === "jeep") return vt.includes("jeep");
        if (category === "tric") return vt.includes("tric");
        if (category === "uv") return vt.includes("uv");
        if (category === "bus") return vt.includes("bus");
        return false;
      });
    }

    function renderCurrentCategory() {
      const tableBody = document.querySelector("#routesTable tbody");
      const title = document.getElementById("tableTitle");
      tableBody.innerHTML = "";

      const categoryText = {
        jeep: "Jeepney Pricing",
        tric: "Tricycle Pricing",
        uv: "UV Express Pricing",
        bus: "Bus Pricing",
      };
      title.textContent = categoryText[currentCategory];

      const routes = filterRoutesByCategory(currentCategory);
      routes.forEach((route) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${route.route_from}</td>
          <td>${route.route_to}</td>
          <td>â‚±${route.estimated_price}</td>
          <td class="actions">
            <a href="#" class="edit" data-id="${route.route_id}">Edit</a>
            <a href="#" class="delete" data-id="${route.route_id}">Delete</a>
          </td>
        `;
        tableBody.appendChild(tr);
      });
    }

    async function addRoute(route_from, route_to, estimated_price, vehicle_type, description) {
      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ route_from, route_to, estimated_price, vehicle_type, description }),
        });
        if (!res.ok) throw new Error("Failed to add route");
        alert("âœ… Route added successfully!");
        fetchRoutes();
      } catch (err) {
        console.error("Error adding route:", err);
        alert("Could not add route.");
      }
    }

    async function updateRoute(id, route_from, route_to, estimated_price, vehicle_type, description) {
      try {
        const res = await fetch(`${API_URL}/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ route_from, route_to, estimated_price, vehicle_type, description }),
        });
        if (!res.ok) throw new Error("Failed to update route");
        alert("âœ… Route updated successfully!");
        fetchRoutes();
      } catch (err) {
        console.error("Error updating route:", err);
        alert("Could not update route.");
      }
    }

    async function deleteRoute(id) {
      if (!confirm("Are you sure you want to delete this route?")) return;
      try {
        const res = await fetch(`${API_URL}/${id}`, { method: "DELETE" });
        if (!res.ok) throw new Error("Failed to delete route");
        alert("ðŸ—‘ï¸ Route deleted successfully!");
        fetchRoutes();
      } catch (err) {
        console.error("Error deleting route:", err);
        alert("Could not delete route.");
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      fetchRoutes();

      const modal = document.getElementById("addRouteModal");
      const openBtn = document.getElementById("openAddRouteModal");
      const closeBtn = document.getElementById("closeModal");
      const submitBtn = document.querySelector(".submit-btn");

      let editMode = false;
      let editId = null;

      openBtn.addEventListener("click", () => {
        editMode = false;
        editId = null;
        submitBtn.textContent = "Add Route";
        modal.style.display = "block";
        modal.querySelectorAll(".input").forEach(i => (i.value = ""));
      });

      closeBtn.addEventListener("click", () => (modal.style.display = "none"));

      submitBtn.addEventListener("click", () => {
        const inputs = modal.querySelectorAll(".input");
        const route_from = inputs[0].value;
        const route_to = inputs[1].value;
        const vehicle_type = inputs[2].value;
        const estimated_price = inputs[3].value;
        const description = inputs[4]?.value || "";

        if (!route_from || !route_to || !estimated_price || vehicle_type === "Vehicle Type") {
          alert("Please fill all fields");
          return;
        }

        if (editMode) {
          updateRoute(editId, route_from, route_to, estimated_price, vehicle_type, description);
        } else {
          addRoute(route_from, route_to, estimated_price, vehicle_type, description);
        }

        modal.style.display = "none";
      });

      // âœ… Category switching
      document.querySelectorAll(".buttonz").forEach((btn) => {
        btn.addEventListener("click", () => {
          document.querySelectorAll(".buttonz").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          currentCategory = btn.dataset.table;
          renderCurrentCategory();
        });
      });

      // âœ… Detect clicks (Edit/Delete)
      document.body.addEventListener("click", (e) => {
        if (e.target.classList.contains("delete")) {
          e.preventDefault();
          const id = e.target.getAttribute("data-id");
          deleteRoute(id);
        }

        if (e.target.classList.contains("edit")) {
          e.preventDefault();
          const id = e.target.getAttribute("data-id");

          const row = e.target.closest("tr");
          const route_from = row.children[0].textContent.trim();
          const route_to = row.children[1].textContent.trim();
          const estimated_price = row.children[2].textContent.replace("â‚±", "").trim();

          const inputs = modal.querySelectorAll(".input");
          inputs[0].value = route_from;
          inputs[1].value = route_to;
          inputs[2].value = document.getElementById("tableTitle").textContent.replace(" Pricing", "");
          inputs[3].value = estimated_price;
          if (inputs[4]) inputs[4].value = "";

          editMode = true;
          editId = id;
          submitBtn.textContent = "Update Route";
          modal.style.display = "block";
        }
      });

      window.onclick = (e) => {
        if (e.target === modal) modal.style.display = "none";
      };
    });
  </script>

</body>
</html>
